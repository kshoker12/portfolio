<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compass App - Documentation</title>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <!-- MathJax for math rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 40px 20px;
        }

        .container {
            width: 100%;
            margin: 0 0;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            line-height: 1.7;
            font-size: 16px;
        }

        h1, h2, h3, h4, h5, h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 9px;
        }

        h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 9px;
        }

        h3 {
            font-size: 1.25em;
        }

        p {
            margin-bottom: 16px;
        }

        ul, ol {
            margin-bottom: 16px;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        blockquote {
            margin: 16px 0;
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid #dfe2e5;
        }

        code {
            background: #f6f8fa;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
        }

        pre {
            background: #2d2d2d;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            margin-bottom: 16px;
        }

        pre code {
            background: transparent;
            padding: 0;
            color: #f8f8f2;
        }

        table {
            border-collapse: collapse;
            margin: 16px 0;
            width: 100%;
        }

        th, td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }

        th {
            background: #f6f8fa;
            font-weight: 600;
        }

        a {
            color: #0366d6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 16px 0;
        }

        hr {
            border: 0;
            border-top: 1px solid #eaecef;
            margin: 24px 0;
        }
        
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div class="container" id="content">
        <p>Loading markdown...</p>
    </div>

    <script>
        // Configure MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };

        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && Prism.languages[lang]) {
                    try {
                        return Prism.highlight(code, Prism.languages[lang], lang);
                    } catch (err) {}
                }
                return code;
            }
        });

        // Fetch and render markdown from file
        const contentDiv = document.getElementById('content');
        
        fetch('CompassApp_Full_Report.md')
            .then(response => response.text())
            .then(markdown => {
                contentDiv.innerHTML = marked.parse(markdown);

                const slugCounts = {};
                const toSlug = (text) => {
                    return (text || '')
                        .toLowerCase()
                        .trim()
                        .replace(/\s+/g, '-')
                        .replace(/[^a-z0-9\-]/g, '')
                        .replace(/\-+/g, '-')
                        .replace(/^\-+|\-+$/g, '');
                };

                const headings = contentDiv.querySelectorAll('h1,h2,h3,h4,h5,h6');
                headings.forEach((h) => {
                    const base = toSlug(h.textContent);
                    let slug = base;
                    if (slugCounts[base] != null) {
                        slugCounts[base] += 1;
                        slug = `${base}-${slugCounts[base]}`;
                    } else {
                        slugCounts[base] = 0;
                    }
                    if (!h.id) h.id = slug;
                });

                // Replace images pointing to video files with HTML5 video players
                const imgs = contentDiv.querySelectorAll('img');
                imgs.forEach((img) => {
                    let src = img.getAttribute('src') || '';
                    if (/\.(mp4|mov|webm)$/i.test(src)) {
                        // Normalize absolute "/..." to relative for subpath deployments
                        if (src.startsWith('/')) src = src.replace(/^\//, '');

                        const makeSource = (url) => {
                            const s = document.createElement('source');
                            s.src = url;
                            const ext = (url.split('.').pop() || '').toLowerCase();
                            s.type = ext === 'mp4' ? 'video/mp4' : ext === 'webm' ? 'video/webm' : ext === 'mov' ? 'video/quicktime' : '';
                            return s;
                        };

                        const video = document.createElement('video');
                        video.setAttribute('controls', '');
                        video.setAttribute('playsinline', '');
                        video.setAttribute('preload', 'metadata');
                        video.style.width = '370px';
                        video.style.maxWidth = '370px';
                        video.style.borderRadius = '6px';

                        // Primary source (original)
                        video.appendChild(makeSource(src));
                        // Fallback attempt: same path but .mp4 (common browser support)
                        if (!/\.mp4$/i.test(src)) {
                            video.appendChild(makeSource(src.replace(/\.(mov|webm)$/i, '.mp4')));
                        }

                        // Fallback content if not supported or 404
                        const fallback = document.createElement('div');
                        fallback.style.fontSize = '14px';
                        fallback.style.marginTop = '8px';
                        fallback.innerHTML = `
                            <p>
                                Unable to play this video in your browser. 
                                <a href="${src}" download>Download video</a> or convert to MP4 (H.264/AAC).
                            </p>
                        `;
                        video.appendChild(fallback);

                        img.replaceWith(video);
                    }
                });

                // Normalize in-page anchor hrefs to our slug format
                const pageLinks = contentDiv.querySelectorAll('a[href^="#"]');
                pageLinks.forEach((a) => {
                    const rawHash = a.getAttribute('href');
                    const rawId = decodeURIComponent((rawHash || '').replace(/^#/, ''));
                    if (!rawId) return;
                    const normalized = `#${toSlug(rawId)}`;
                    a.setAttribute('href', normalized);
                });

                contentDiv.addEventListener('click', (e) => {
                    const link = e.target.closest && e.target.closest('a[href^="#"]');
                    if (!link) return;
                    const hash = decodeURIComponent(link.getAttribute('href'));
                    if (!hash || hash === '#' || hash.startsWith('#!')) return;
                    const id = hash.slice(1);
                    const normalizedId = toSlug(id);
                    const el = document.getElementById(normalizedId) || document.getElementById(id);
                    if (el) {
                        e.preventDefault();
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        try { history.replaceState(null, '', `#${normalizedId}`); } catch (_) {}
                    }
                });

                // Render math equations with MathJax
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([contentDiv]).catch((err) => {
                        console.error('MathJax rendering error:', err);
                    });
                } else {
                    // If MathJax hasn't loaded yet, wait for it
                    window.addEventListener('load', () => {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            window.MathJax.typesetPromise([contentDiv]).catch((err) => {
                                console.error('MathJax rendering error:', err);
                            });
                        }
                    });
                }
            })
            .catch(error => {
                contentDiv.innerHTML = `<p style="color: red;">Error loading markdown file: ${error.message}</p>`;
            });
    </script>
</body>
</html>
